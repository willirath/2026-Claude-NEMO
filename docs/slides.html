<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude vs. Nemo</title>
<link rel="stylesheet" href="reveal/reveal.css">
<link rel="stylesheet" href="reveal/white.css">
<style>
  .reveal { font-size: 32px; }
  .reveal h1 { font-size: 1.8em; }
  .reveal h2 { font-size: 1.4em; }
  .reveal h3 { font-size: 1.1em; }
  .reveal blockquote { font-size: 0.85em; background: #f9f9f9; border-left: 4px solid #888; padding: 0.5em 1em; width: 85%; }
  .reveal table { font-size: 0.65em; margin: 0.5em auto; }
  .reveal th, .reveal td { padding: 0.25em 0.6em; }
  .reveal pre { font-size: 0.55em; width: 90%; }
  .reveal code { font-size: 0.9em; }
  .reveal img { max-height: 500px; }
  .reveal .small { font-size: 0.7em; color: #666; }
  .reveal section { text-align: left; }
  .reveal h1, .reveal h2, .reveal h3 { text-align: center; }
  .reveal .center { text-align: center; }
</style>
</head>
<body>
<div class="reveal">
<div class="slides">

<!-- ════════════════════════════════════════════ -->
<!-- INTRO -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Claude vs. Nemo</h1>
    <blockquote class="center">I want to run the NEMO ocean model Gyre configuration
    which is defined in the main NEMO repo. Let's plan this out.</blockquote>
    <p class="center small">Multiple Claude Code sessions across three days &mdash; February 2026</p>
    <p class="center small"><a href="https://github.com/willirath/2026-Claude-NEMO">github.com/willirath/2026-Claude-NEMO</a>
    &bull; <a href="https://github.com/willirath/2026-Claude-NEMO/blob/main/docs/conversation.md">conversation log</a></p>
  </section>

  <section>
    <h2>The Goal</h2>
    <p>Stand up a <strong>NEMO ocean model</strong> simulation from scratch:</p>
    <ul>
      <li>Dockerized build of a large Fortran codebase</li>
      <li>Idealized double-gyre configuration (mid-latitude Atlantic analog)</li>
      <li>Automated analysis pipeline with Jupyter notebooks</li>
      <li>Shared analysis library with proper grid handling</li>
      <li>HPC deployment via Singularity for decade-scale runs</li>
    </ul>
    <p style="margin-top:1em;">The kind of project that normally involves reading documentation,
    trial-and-error compilation, and a lot of plumbing &mdash;
    done here as a conversation.</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- GETTING IT RUNNING -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Getting It Running</h1>
    <blockquote class="center">Don't go too far without talking to me.</blockquote>
  </section>

  <section>
    <h3>Challenging the AI's Assumptions</h3>
    <blockquote>Defer XIOS until we notice we need it.</blockquote>
    <p>Claude claimed XIOS (an external I/O server) was a hard dependency.
    The user knew better:</p>
    <blockquote>I think that's not accurate. Review IO again. There should be
    a way to write <code>_{T,U,V,W}</code> files without XIOS.</blockquote>
    <p>Investigation proved the user right &mdash; a bundled library (IOIPSL) handles
    output natively. This eliminated an entire build stage and a major
    source of complexity.</p>
  </section>

  <section>
    <h3>Plan-Driven Workflow</h3>
    <blockquote>Plans go to plans dir and are written as markdown files.</blockquote>
    <blockquote>Review the plan and find out if we need to adapt the analysis stage.</blockquote>
    <blockquote>Commit updated plan and then act on stage 03.</blockquote>
    <p>Numbered milestones in <code>plans/</code> gave the AI a shared roadmap
    and the user a way to steer without micromanaging.</p>
    <pre><code>nemo/                       # NEMO source (git submodule, read-only)
configs/GYRE_DOCKER/        # NEMO config (CPP keys, namelist, MY_SRC)
plans/                      # Milestone docs (markdown)
analysis/*.ipynb            # Jupyter notebooks
Makefile                    # make build &rarr; run &rarr; analyze</code></pre>
    <p class="small">Key constraint: <code>nemo/</code> is a submodule &mdash; we can read it
    but must not modify it.</p>
  </section>

  <section>
    <h3>Proactive Review</h3>
    <blockquote>Should we track the workflow in a Makefile right away?</blockquote>
    <blockquote>Check if (looking forward) we might be running into problems
    with current structure.</blockquote>
    <p>Before moving on, the user asked Claude to audit the setup.
    Four issues surfaced: missing <code>.dockerignore</code>, hardcoded x86_64 paths
    (would break on ARM Mac), error-swallowing <code>|| true</code>, and poor
    Docker layer ordering.</p>
    <p>All fixed before they could cause problems downstream.</p>
  </section>

  <section>
    <h3>The Debugging Loop</h3>
    <p>Building and running NEMO in Docker required several rounds of
    fix-and-retry &mdash; typical for deploying Fortran codes in containers:</p>
    <ul>
      <li><strong>Build:</strong> <code>makenemo -j12</code> fails &mdash; needs <code>-j 4</code> (space-separated);
        missing <code>liburi-perl</code> in the container</li>
      <li><strong>Runtime:</strong> Fortran format overflow &mdash; Docker container IDs too long
        for NEMO's hostname field. Fixed with <code>--hostname nemo</code></li>
      <li><strong>Dependencies:</strong> Biogeochemistry module (PISCES) pulling in
        external forcing files that don't exist in a clean setup</li>
    </ul>
    <p>The AI traced each error and applied targeted fixes.
    The user made the architectural call:</p>
    <blockquote>What's the PISCES part in our simulation? Should we erase it completely?</blockquote>
    <blockquote>Drop it. RENAME TO GYRE.</blockquote>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- ANALYSIS -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Analysis</h1>
    <blockquote class="center">Let's use Jupyter notebooks instead of .py files. Literate
    programming is easier to investigate by humans.</blockquote>
    <blockquote class="center">Add analyses: surface heat flux, total heat content time series,
    total KE time series, mean salinity time series (should be constant),
    wind stress quiver.</blockquote>
  </section>

  <section>
    <h3>Steering the Analysis</h3>
    <blockquote>Put the plots on a regional map with cartopy. Use stereographic projection,
    add coastlines. Don't worry that the rect box doesn't fit the coastlines.
    We <em>want</em> to see its approx position on the globe and its shape in
    relation to the real Atlantic basin.</blockquote>
    <p>The user specified format, projection, and physics; Claude created
    the notebooks, checked variable names, and wired up the Makefile.</p>
    <div class="center" style="display: flex; justify-content: center; gap: 15px;">
      <img src="./sst_mean.png" alt="Mean SST" style="max-height: 400px;">
      <img src="./heat_flux.png" alt="Surface heat flux" style="max-height: 400px;">
    </div>
  </section>

  <section>
    <h3>Plausible but Wrong</h3>
    <blockquote>Are you sure about the wind stress and current directions?
    They are in delx, dely direction, I think.</blockquote>
    <p>Claude plotted vectors as if grid-aligned = geographic.
    But the GYRE grid is rotated <strong>45&deg;</strong> &mdash; every vector was wrong.</p>
    <div class="center" style="display: flex; justify-content: center; gap: 15px;">
      <img src="./wind_stress_wrong.png" alt="Wind stress (wrong)" style="max-height: 380px;">
      <img src="./wind_stress.png" alt="Wind stress (corrected)" style="max-height: 380px;">
    </div>
    <p class="center small">The user caught it from domain knowledge. The AI would have shipped this.</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- SCALING UP -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Scaling Up</h1>
    <blockquote class="center">Let's increase the spatial resolution to 1/5 deg. Git branch first.</blockquote>
    <blockquote class="center">Might want to go for a really short run first?</blockquote>
  </section>

  <section>
    <h3>Resolution and Parallelization</h3>
    <p>Grid: 32&times;22 &rarr; 160&times;110. Claude derived all dependent parameters
    (timestep, diffusion, output frequency) from scaling arguments.
    10-step smoke test, then 5-minute run, then full simulation.</p>
    <blockquote>Can we use OpenMP for shared memory?</blockquote>
    <p>Claude investigated: NEMO has zero OpenMP directives &mdash; parallelism is
    purely MPI. Switched to 4 ranks.
    <strong>2.6&times; speedup</strong> (0.10 &rarr; 0.039 s/step).</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- CORRECTNESS & CODE QUALITY -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Correctness &amp; Code Quality</h1>
    <blockquote class="center">Look at outputs (esp plots) and tune them.
    There's a few obvious issues.</blockquote>
  </section>

  <section>
    <h3>Physical Correctness</h3>
    <blockquote>Ensure NEMO grid is respected for aggregations.</blockquote>
    <p>Domain means used flat <code>.mean()</code> &mdash; no area weighting, no
    land mask. On NEMO's rotated grid with varying cell sizes, this silently
    biased every spatial aggregate.</p>
    <p>The fix: <code>.weighted(cell_area * interior).mean()</code>, zonal means
    weighted by <code>e1t</code>, proper boundary exclusion.</p>
    <p class="small">Other catches by the user: Docker <code>--cpus</code> is a quota not a
    core-pinning flag (800% CPU observed); boundary ring included in averages.</p>
  </section>

  <section>
    <h3>Code Quality</h3>
    <blockquote>Ensure proper xarray API is used rather than sending around np arrays.</blockquote>
    <blockquote>Don't hide the output dir in the lib. Really bad pattern.</blockquote>
    <p>Notebooks extracted <code>.values</code> immediately, discarding
    xarray's coordinate-aware operations. Claude refactored to use
    <code>.where()</code>, <code>.weighted()</code>, <code>.isel()</code>.</p>
    <p>Duplicated boilerplate extracted into <code>analysis/gyre.py</code>
    (9 functions). Setup cells shrank from ~30 to ~5 lines.</p>
    <p class="small">The user required: mandatory parameters (no hidden defaults),
    type hints, proper markdown documentation in every notebook.</p>
  </section>

  <section>
    <h3>Calendar Fix</h3>
    <blockquote>Where's a good place to fix the calendar? I don't want this
    repeated in every notebook.</blockquote>
    <p>IOIPSL writes <code>360d</code> but CF conventions require <code>360_day</code>.
    Hardcoded in NEMO's <code>domain.F90</code> &mdash; can't fix without patching the submodule.</p>
    <p>Solution: a one-liner in the Makefile post-processes the NetCDF attributes
    after <code>rebuild_nemo</code>. Fixed once, all notebooks benefit.</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- LITERATURE & CONFIGURATION -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Literature Research</h1>
    <blockquote class="center">There's a 2010 Levy paper defining the GYRE.
    And there's a 2023(&plusmn;2y) paper by Bagaeva who set up a GYRE with FESOM.
    Read these papers and summarize params of the 20&thinsp;km configs.</blockquote>
  </section>

  <section>
    <h3>Navigating Paywalls</h3>
    <p>Both papers were behind paywalls. Claude tried DOI redirects,
    ResearchGate, preprint archives, user-agent spoofing &mdash; all blocked.</p>
    <blockquote>Can't you parse PDF?</blockquote>
    <p>The user provided a local Zotero path. Claude installed
    <code>pdfminer-six</code> and extracted the text. Also pulled Levy's
    parameters directly from the NEMO Fortran source
    (<code>usrdef_nam.F90</code>, <code>usrdef_sbc.F90</code>).</p>
  </section>

  <section>
    <h3>Configuration Comparison</h3>
    <blockquote>What about runtimes, ignored spinup, diags used and plotted?</blockquote>
    <table>
      <tr><th></th><th>Levy 2010</th><th>Bagaeva 2024</th><th>GYRE_DOCKER</th></tr>
      <tr><td><strong>Model</strong></td><td>NEMO</td><td>FESOM</td><td>NEMO</td></tr>
      <tr><td><strong>Resolution</strong></td><td>1/5&deg;</td><td>~20 km</td><td>1/5&deg;</td></tr>
      <tr><td><strong>Runtime</strong></td><td>100 yr (70 spinup)</td><td>59 yr</td><td>10 yr (so far)</td></tr>
      <tr><td><strong>Diagnostics</strong></td><td>SSH, SST, &psi;</td><td>SSH, SST, KE</td><td>SSH, SST, KE, fluxes</td></tr>
    </table>
    <p class="small">Decade-scale runs are the entry point for meaningful
    ocean dynamics &mdash; hence the HPC deployment.</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- HPC DEPLOYMENT -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>HPC Deployment</h1>
    <blockquote class="center">I'd like to run this big run on an HPC centre.
    Plan this out with minimal interaction with me (I'm busy otherwise.)</blockquote>
  </section>

  <section>
    <h3>The Pipeline</h3>
    <blockquote>Give me list of commands (c/p able) that I need to run on nesh.
    I just logged in.</blockquote>
    <p>Local Mac (ARM) &rarr; NESH cluster (x86, SLURM, Singularity):</p>
    <pre><code># Local: cross-build and push to GitHub Container Registry
make push    # docker buildx --platform linux/amd64 --push

# NESH: pull as Singularity image and run
singularity pull nemo-gyre.sif docker://ghcr.io/...
NEMO_ITEND=108000 sbatch hpc/job.sh    # 10-year run</code></pre>
    <p class="small">First push failed: <code>gh auth token</code> lacked
    <code>write:packages</code> scope. Build layers cached &mdash; second push took 11 seconds.</p>
  </section>

  <section>
    <h3>Four Rounds of Remote Debugging</h3>
    <blockquote>Do we need to bind the host MPI for single node execution?</blockquote>
    <p>No &mdash; container MPI works fine for single-node. The user caught this
    before it became a problem. Then: run on NESH, paste errors back,
    Claude diagnoses without cluster access:</p>
    <table>
      <tr><th>#</th><th>Error</th><th>Root cause</th></tr>
      <tr><td>1</td><td><code>/var/spool/slurmd/nemo-gyre.sif</code></td>
        <td>SLURM copies scripts to spool &mdash; use <code>$SLURM_SUBMIT_DIR</code></td></tr>
      <tr><td>2</td><td><code>/scratch: Read-only</code></td>
        <td>Container MPI needs <code>OMPI_MCA_orte_tmpdir_base=/tmp</code></td></tr>
      <tr><td>3</td><td><code>unable to execute /opt/nemo-run/nemo</code></td>
        <td>Bind mount hides symlink &mdash; use absolute executable path</td></tr>
      <tr><td>4</td><td><code>calendar '360d'</code></td>
        <td>Same IOIPSL fix needed in job script</td></tr>
    </table>
    <p class="small">Plus: no host MPI needed for single-node (user caught this);
    <code>$HOME</code> quota avoidance; gitignore trailing-slash vs symlink.</p>
  </section>

  <section>
    <h3>10-Year Run</h3>
    <blockquote>So go for 10 years. Make sure the output symlinking doesn't fail
    if output symlink exists.</blockquote>
    <p>After the fixes, the 1-year test run completed on NESH.
    <code>make analyze</code> ran the notebooks against the HPC output.</p>
    <p>Then: <code>NEMO_ITEND=108000 sbatch hpc/job.sh</code> &mdash;
    a 10-year simulation, ~2.5 hours on a single NESH node.</p>
    <blockquote>Let's use a repo-local singularity cache dir and just ignore it.</blockquote>
    <p class="small">Practical decisions made in passing: cache placement,
    gitignore updates, <code>output</code> symlink handling &mdash; each a one-liner
    from the user, resolved immediately.</p>
  </section>
</section>

<!-- ════════════════════════════════════════════ -->
<!-- OBSERVATIONS -->
<!-- ════════════════════════════════════════════ -->
<section>
  <section>
    <h1>Observations</h1>
    <blockquote class="center">I think that's not accurate.</blockquote>
    <blockquote class="center">Are you sure about the wind stress and current directions?</blockquote>
    <blockquote class="center">Don't hide the output dir in the lib. Really bad pattern.</blockquote>
  </section>

  <section>
    <h3>Efficient Communication</h3>
    <blockquote>Add savefig calls, subset the quiver, extend run, then <code>make all</code>.</blockquote>
    <p>One prompt, four changes. Full pipeline ran end to end.</p>
    <blockquote>OK. Then let's go for a 1-year run. Adapt namelist,
    run <code>make clean</code>, <code>make all</code>. No interventions allowed.</blockquote>
    <p>Once a shared understanding was established, complex multi-step
    instructions could be given in a single sentence. The plan-driven
    workflow paid off &mdash; both sides knew the vocabulary.</p>
  </section>

  <section>
    <h3>Enforcing Conventions</h3>
    <blockquote>Let's figure out how we deal with the fact that we cannot mod
    the <code>nemo/</code> contents directly.</blockquote>
    <p>Claude had edited inside the read-only <code>nemo/</code> submodule.
    The user flagged it; solution was an external config directory
    (<code>configs/GYRE_DOCKER/</code>) built via <code>makenemo -t</code>.</p>
    <p>The AI treated the submodule as just another directory.
    Repo structure conventions needed to be explicitly enforced &mdash;
    the AI didn't infer them from context.</p>
  </section>

  <section>
    <h3>The Pattern</h3>
    <table>
      <tr><th></th><th>Human</th><th>AI</th></tr>
      <tr><td><strong>Strengths</strong></td>
        <td>Domain knowledge, architectural judgment,<br>API design instincts, quality review</td>
        <td>Source navigation, mechanical iteration,<br>cross-platform plumbing, debugging cascades</td></tr>
      <tr><td><strong>Examples</strong></td>
        <td>XIOS is optional; vectors need rotation;<br>
          area weighting required; no hidden defaults;<br>
          host MPI unnecessary for single-node;<br>
          Docker CPU quota &ne; core pinning</td>
        <td>Finding IOIPSL in Fortran source;<br>
          refactoring 5 notebooks + shared library;<br>
          cross-building amd64 image via QEMU;<br>
          diagnosing 4 SLURM failures from error logs</td></tr>
    </table>
    <p style="margin-top:0.8em;">Not a replacement for expertise, but a <strong>multiplier</strong> for it.</p>
    <p class="small">Caveats: context limits hit repeatedly; the AI confidently stated
    incorrect facts and produced plausible but wrong output; API design and
    repo conventions needed explicit enforcement.</p>
  </section>
</section>

</div>
</div>
<script type="module">
import Reveal from './reveal/reveal.esm.js';
Reveal.initialize({
  hash: true,
  slideNumber: true,
  width: 1280,
  height: 720,
  margin: 0.08,
  transition: 'slide',
});
</script>
</body>
</html>

# CLAUDE.md

## Project Overview

Dockerized NEMO ocean model running the GYRE configuration — an idealized wind-driven double-gyre basin on a beta-plane. The pipeline builds NEMO in Docker, runs the simulation, and analyzes the output with Python.

## Quick Reference

```
make all        # Full pipeline: build → run → analyze
make build      # Build Docker image (compiles NEMO with gfortran/OpenMPI)
make run        # Run simulation (4 MPI ranks), output NetCDF to output/
make analyze    # Execute analysis notebooks (headless)
make clean      # Remove output/
```

## Project Structure

- `Dockerfile` — Debian bookworm image, compiles NEMO with `makenemo -t /configs`
- `docker/arch-docker.fcm` — Compiler/library config for Docker build
- `configs/GYRE_DOCKER/` — Project-specific NEMO config (see `configs/GYRE_DOCKER/README.md`):
  - `cpp_GYRE_DOCKER.fcm` — CPP keys (compile-time features)
  - `EXPREF/namelist_cfg` — Runtime parameters (resolution, timestep, output)
  - `MY_SRC/usrdef_sbc.F90` — Modified surface forcing: no seasonal cycle, weak restoring (−4 W/m²/K), no E-P
- `nemo/` — NEMO source (git submodule, read-only — files inside can't be tracked by parent repo)
- `analysis/ssh.ipynb` — SSH variance and domain-mean time series
- `analysis/sst.ipynb` — Mean SST, temporal evolution, meridional gradient
- `analysis/circulation.ipynb` — Surface currents and kinetic energy
- `analysis/vorticity.ipynb` — Snapshot vorticity (ζ/f) and wind stress curl
- `analysis/eddies.ipynb` — Multi-panel eddy snapshots (vorticity + speed)
- `output/` — Simulation results (gitignored, regenerated by `make run`)
- `plans/` — Development milestone docs
- `pixi.toml` / `pixi.lock` — Python environment (xarray, matplotlib, netcdf4, cartopy, numpy)

## NEMO Configuration

Adapted to match the Bagaeva et al. (2024) 20 km no-backscatter double-gyre
baseline. See `plans/bagaeva_adaptation.md` for full rationale and remaining
differences.

- **Config**: GYRE (physics-only, no PISCES/biogeochemistry)
- **CPP keys**: `key_linssh key_vco_1d` (linear free surface, 1D vertical coord)
- **Resolution**: ~21 km (nn_GYRE=5), 152×102 grid points, 31 vertical levels
- **Viscosity**: Biharmonic (bilaplacian), ahm ≈ 6.67×10¹⁰ m⁴/s
- **EOS**: Linear, T-dependent only (simplified EOS)
- **Vertical mixing**: Pacanowski-Philander (Richardson-number dependent)
- **Bottom drag**: Linear, Cd = 10⁻³ m/s
- **Forcing**: Analytical, steady (no seasonal cycle), heat restoring −4 W/m²/K, no E-P
- **Run length**: 59 years (50 spinup + 9 analysis), timestep 2880 s
- **Output**: 10-day averaged NetCDF via IOIPSL (no XIOS)
- **MPI**: 4 ranks with domain decomposition, recombined via `rebuild_nemo`

## Output Files

All in `output/`, prefixed `GYRE_10d_<startdate>_<enddate>_`:
- `grid_T.nc` — Temperature, salinity, SSH (`sossheig`), SST, SSS
- `grid_U.nc` — U-velocity
- `grid_V.nc` — V-velocity
- `grid_W.nc` — W-velocity
- `GYRE_<step>_restart_000{0..3}.nc` — Per-rank restart files
- `mesh_mask.nc` — Grid geometry and land/sea masks

## MY_SRC Modifications

`configs/GYRE_DOCKER/MY_SRC/usrdef_sbc.F90` overrides the default GYRE surface
forcing (`nemo/src/OCE/USR/usrdef_sbc.F90`) with three changes to match Bagaeva
et al. (2024):

**1. Seasonal cycle removed** — zeroed out the cosine modulators that drive
seasonal variability in wind, heat flux, and freshwater:

```fortran
! Was:
zcos_sais1 = COS( (ztime - ztimemax1) / (ztimemin1 - ztimemax1) * rpi )
zcos_sais2 = COS( (ztime - ztimemax2) / (ztimemax2 - ztimemin2) * rpi )
! Now:
zcos_sais1 = 0._wp
zcos_sais2 = 0._wp
```

Wind stress similarly simplified from `ztaun = ztau - ztau_sais * COS(...)` to
just `ztaun = ztau`.

**2. Heat flux restoring weakened** — coupling coefficient reduced 10× to match
Bagaeva's γ = 4 W/m²/K (vs. Lévy's 40):

```fortran
! Was:
ztrp = -40.e0
! Now:
ztrp = -4.e0
```

**3. Freshwater flux (E-P) removed** — Bagaeva keeps salinity constant with no
freshwater forcing:

```fortran
! Was: sinusoidal E-P with domain-mean subtraction
! Now:
emp(ji,jj) = 0.0_wp
sfx(ji,jj) = 0.0_wp
```

## Key Decisions

- **No XIOS**: Uses bundled IOIPSL for NetCDF output, avoiding a complex dependency
- **`--hostname nemo`** in `docker run`: Prevents gfortran format overflow from long container IDs
- **Physics-only**: `key_top` (PISCES) dropped to simplify the build (see `configs/GYRE_DOCKER/cpp_GYRE_DOCKER.fcm`)
- **External config**: `configs/GYRE_DOCKER/` holds all project-specific NEMO settings, built via `makenemo -t`; submodule stays read-only
- **MPI rebuild**: Multi-rank output recombined with `rebuild_nemo` tool (compiled in Docker image)

## Analysis

Jupyter notebooks in `analysis/` provide literate-programming style analysis. `make analyze` executes them headless via `pixi run jupyter execute`. Open interactively with `pixi run jupyter lab`. Notebooks use grid_T (SSH, SST) and grid_U/V (surface currents).

## Prerequisites

- Docker
- [Pixi](https://pixi.sh) (Python environment manager)
- Git submodules initialized (`git submodule update --init`)

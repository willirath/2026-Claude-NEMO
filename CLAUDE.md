# CLAUDE.md

## Project Overview

Dockerized NEMO ocean model running the GYRE configuration — an idealized wind-driven double-gyre basin on a beta-plane. The pipeline builds NEMO in Docker, runs a 6-month simulation at 1/5° resolution, and analyzes the output with Python.

## Quick Reference

```
make all        # Full pipeline: build → run → analyze
make build      # Build Docker image (compiles NEMO with gfortran/OpenMPI)
make run        # Run 6-month simulation (4 MPI ranks), output NetCDF to output/
make analyze    # Execute analysis notebooks (headless)
make clean      # Remove output/
```

## Project Structure

- `Dockerfile` — Debian bookworm image, compiles NEMO with `makenemo -t /configs`
- `docker/arch-docker.fcm` — Compiler/library config for Docker build
- `configs/GYRE_DOCKER/` — Project-specific NEMO config (see `configs/GYRE_DOCKER/README.md`):
  - `cpp_GYRE_DOCKER.fcm` — CPP keys (compile-time features)
  - `EXPREF/namelist_cfg` — Runtime parameters (resolution, timestep, output)
  - `MY_SRC/` — Custom Fortran source overrides (empty, uses GYRE defaults)
- `nemo/` — NEMO source (git submodule, read-only — files inside can't be tracked by parent repo)
- `analysis/ssh.ipynb` — SSH variance and domain-mean time series
- `analysis/sst.ipynb` — Mean SST, temporal evolution, meridional gradient
- `analysis/circulation.ipynb` — Surface currents and kinetic energy
- `output/` — Simulation results (gitignored, regenerated by `make run`)
- `plans/` — Development milestone docs
- `pixi.toml` / `pixi.lock` — Python environment (xarray, matplotlib, netcdf4, cartopy, numpy)

## NEMO Configuration

- **Config**: GYRE (physics-only, no PISCES/biogeochemistry)
- **CPP keys**: `key_linssh key_vco_1d` (linear free surface, 1D vertical coord)
- **Grid**: 160×110 horizontal, 31 vertical levels, 1/5° resolution
- **Timestep**: 48 min (2880s), total 5400 steps = 180 days (6 months, 360-day calendar)
- **Output**: 10-day averaged NetCDF via IOIPSL (no XIOS), `nn_write=300`
- **Forcing**: Analytical (user-defined, no input files needed)
- **MPI**: 4 ranks with domain decomposition, recombined via `rebuild_nemo`

## Output Files

All in `output/`, prefixed `GYRE_10d_00010101_00010630_`:
- `grid_T.nc` — Temperature, salinity, SSH (`sossheig`), SST, SSS
- `grid_U.nc` — U-velocity
- `grid_V.nc` — V-velocity
- `grid_W.nc` — W-velocity
- `GYRE_00005400_restart_000{0..3}.nc` — Per-rank restart files
- `mesh_mask.nc` — Grid geometry and land/sea masks

## Key Decisions

- **No XIOS**: Uses bundled IOIPSL for NetCDF output, avoiding a complex dependency
- **`--hostname nemo`** in `docker run`: Prevents gfortran format overflow from long container IDs
- **Physics-only**: `key_top` (PISCES) dropped to simplify the build (see `configs/GYRE_DOCKER/cpp_GYRE_DOCKER.fcm`)
- **External config**: `configs/GYRE_DOCKER/` holds all project-specific NEMO settings, built via `makenemo -t`; submodule stays read-only
- **MPI rebuild**: Multi-rank output recombined with `rebuild_nemo` tool (compiled in Docker image)

## Analysis

Jupyter notebooks in `analysis/` provide literate-programming style analysis. `make analyze` executes them headless via `pixi run jupyter execute`. Open interactively with `pixi run jupyter lab`. Notebooks use grid_T (SSH, SST) and grid_U/V (surface currents).

## Prerequisites

- Docker
- [Pixi](https://pixi.sh) (Python environment manager)
- Git submodules initialized (`git submodule update --init`)

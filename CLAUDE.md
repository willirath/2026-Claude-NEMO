# CLAUDE.md

## Project Overview

Dockerized NEMO ocean model running the GYRE configuration — an idealized wind-driven double-gyre basin on a beta-plane. The pipeline builds NEMO in Docker, runs a 2-year simulation, and analyzes the output with Python.

## Quick Reference

```
make all        # Full pipeline: build → run → analyze
make build      # Build Docker image (compiles NEMO with gfortran/OpenMPI)
make run        # Run 2-year simulation, output NetCDF to output/
make analyze    # Generate SSH variance plot from output/
make clean      # Remove output/
```

## Project Structure

- `Dockerfile` — Debian bookworm image, compiles NEMO with `makenemo`
- `docker/arch-docker.fcm` — Compiler/library config for Docker build
- `nemo/` — NEMO source (git submodule). Config lives in `nemo/cfgs/GYRE_PISCES/EXPREF/`
- `analysis/ssh_variance.py` — Plots SSH temporal variance from grid_T output
- `output/` — Simulation results (gitignored, regenerated by `make run`)
- `plans/` — Development milestone docs
- `pixi.toml` / `pixi.lock` — Python environment (xarray, matplotlib, netcdf4, cartopy, numpy)

## NEMO Configuration

- **Config**: GYRE (physics-only, no PISCES/biogeochemistry)
- **CPP keys**: `key_linssh key_vco_1d` (linear free surface, 1D vertical coord)
- **Grid**: 32×22 horizontal, 31 vertical levels, 1° resolution
- **Timestep**: 4 hours (14400s), total 4320 steps = 720 days (2 years, 360-day calendar)
- **Output**: 10-day averaged NetCDF via IOIPSL (no XIOS), `nn_write=60`
- **Forcing**: Analytical (user-defined, no input files needed)
- **MPI**: Single process (`-np 1`)

## Output Files

All in `output/`, prefixed `GYRE_10d_00010101_00021230_`:
- `grid_T_0000.nc` — Temperature, salinity, SSH (`sossheig`), SST, SSS
- `grid_U_0000.nc` — U-velocity
- `grid_V_0000.nc` — V-velocity
- `grid_W_0000.nc` — W-velocity
- `GYRE_00004320_restart.nc` — Restart file
- `mesh_mask.nc` — Grid geometry and land/sea masks

## Key Decisions

- **No XIOS**: Uses bundled IOIPSL for NetCDF output, avoiding a complex dependency
- **`--hostname nemo`** in `docker run`: Prevents gfortran format overflow from long container IDs
- **Physics-only**: `key_top` (PISCES) dropped to simplify the build
- **Namelist**: `nemo/cfgs/GYRE_PISCES/EXPREF/namelist_cfg` controls all runtime parameters

## Analysis

The `analyze` target runs `pixi run python analysis/ssh_variance.py output/`. It computes temporal variance of SSH and produces a spatial plot showing the expected western boundary intensification pattern. Only `grid_T` is used; U/V/W files are available for further analysis.

## Prerequisites

- Docker
- [Pixi](https://pixi.sh) (Python environment manager)
- Git submodules initialized (`git submodule update --init`)
